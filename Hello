---
- name: Gather user accounts with UID greater than 999
  hosts: all
  become: yes
  vars:
    system_uid_max: 999
    ignored_users: ['md', 'cl']
    users_to_delete: []

  tasks:
    - name: Get users with UID greater than 999
      shell: "awk -F: '($3 > {{ system_uid_max }}) {print $1}' /etc/passwd"
      changed_when: false
      register: users_with_high_uid

    - name: Filter out ignored users
      set_fact:
        users_to_delete: "{{ users_with_high_uid.stdout_lines | difference(ignored_users) }}"

    - name: Show users to delete
      debug:
        var: users_to_delete

    - name: Delete users with high UID
      user:
        name: "{{ item }}"
        state: absent
      with_items: "{{ users_to_delete }}"
      ignore_errors: yes




---
- name: Check and modify UID of cbflow and mgmtbld users if they exist
  hosts: all
  become: yes
  vars:
    cbflow_uid: 766
    mgmtbld_uid: 767

  tasks:
    - name: Check if cbflow user exists
      command: getent passwd cbflow
      register: cbflow_user
      ignore_errors: yes

    - name: Change UID of cbflow if it exists
      user:
        name: cbflo
        uid: "{{ cow_uid }}"
        state: present
      when: cbflow_user.rc == 0

    - name: Check if mgmtbld user exists
      command: getent passwd mgmd
      register: mtbld_user
      ignore_errors: yes

    - name: Change UID of mgmtbld if it exists
      user:
        name: mgmtbld
        uid: "{{ mgld_uid }}"
        state: present
      when: mgmtbld_user.rc == 0
