- name: Pause processes, change UID, and resume processes for mgmtbld
  hosts: all
  become: yes
  tasks:
    - name: List running processes for mgmtbld
      shell: pgrep -u mgmtbld
      register: mgmtbld_processes
      failed_when: mgmtbld_processes.rc not in [0, 1]
      changed_when: false

    - name: Pause running processes for mgmtbld
      shell: kill -SIGSTOP {{ item }}
      with_items: "{{ mgmtbld_processes.stdout_lines }}"
      when: mgmtbld_processes.rc == 0

    - name: Change UID of mgmtbld
      user:
        name: mgmtbld
        uid: 1234  # Desired UID

    - name: Resume paused processes for mgmtbld
      shell: kill -SIGCONT {{ item }}
      with_items: "{{ mgmtbld_processes.stdout_lines }}"
      when: mgmtbld_processes.rc == 0


- name: Pause processes, change UID, and resume processes for mgmtbld
  hosts: all
  become: yes
  tasks:
    - name: List running processes for mgmtbld
      shell: pgrep -u mgmtbld
      register: mgmtbld_processes
      failed_when: mgmtbld_processes.rc not in [0, 1]
      changed_when: false

    - name: Pause running processes for mgmtbld
      shell: |
        for pid in {{ mgmtbld_processes.stdout_lines | join(' ') }}; do
          timeout 5s kill -STOP $pid
        done
      when: mgmtbld_processes.rc == 0

    - name: Change UID of mgmtbld
      user:
        name: mgmtbld
        uid: 1234  # Desired UID

    - name: Resume paused processes for mgmtbld
      shell: |
        for pid in {{ mgmtbld_processes.stdout_lines | join(' ') }}; do
          kill -CONT $pid
        done
      when: mgmtbld_processes.rc == 0




- name: Pause processes, change UID, and resume processes for mgmtbld
  hosts: all
  become: yes
  tasks:
    - name: List running processes for mgmtbld
      shell: pgrep -u mgmtbld
      register: mgmtbld_processes
      failed_when: mgmtbld_processes.rc not in [0, 1]
      changed_when: false

    - name: Pause running processes for mgmtbld
      shell: |
        paused_pids=""
        for pid in {{ mgmtbld_processes.stdout_lines | join(' ') }}; do
          if timeout 5s kill -STOP $pid; then
            paused_pids+="$pid "
          fi
        done
        echo $paused_pids
      register: paused_processes
      when: mgmtbld_processes.rc == 0

    - name: Change UID of mgmtbld
      user:
        name: mgmtbld
        uid: 1234  # Desired UID
      when: paused_processes.stdout != ""

    - name: Resume paused processes for mgmtbld
      shell: |
        for pid in {{ paused_processes.stdout | trim | split(' ') }}; do
          kill -CONT $pid
        done
      when: paused_processes.stdout != ""





- name: Pause processes, update sudoers, set UID, and resume processes
  hosts: all
  become: yes
  tasks:
    - name: List running processes for Jenkins user
      shell: pgrep -u Tegethid
      register: jenkins_processes
      failed_when: jenkins_processes.rc != 0
      changed_when: false

    - name: Debug Jenkins processes
      debug:
        var: jenkins_processes

    - name: Pause running processes for Jenkins user
      shell: |
        for pid in {{ jenkins_processes.stdout_lines }}; do
          kill -STOP $pid
        done
      when: jenkins_processes.rc == 0

    - name: Add Jenkins user to sudoers list
      copy:
        content: "Tegethid ALL=(ALL:ALL) NOPASSWD: ALL"
        dest: /etc/sudoers.d/Tegethid
        mode: '0440'
      become_user: root

    - name: Set UID for Jenkins user
      user:
        name: Tegethid
        uid: <desired_UID_here>
      become_user: root

    - name: Resume paused processes for Jenkins user
      shell: |
        for pid in {{ jenkins_processes.stdout_lines }}; do
          kill -CONT $pid
        done
      when: jenkins_processes.rc == 0

